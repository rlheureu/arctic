{% extends "base.html" %}
{% block styling %}
  {{ super() }}
  <style type="text/css">
  .benchtab{
    display: inline-block;
    position: relative;
    top:11px;
    padding-bottom:15px;
    cursor: pointer;
  }
  .benchtab-disabled{
    cursor: default;
  }
  .benchtabsep{
    display: inline-block;
    position: relative;
    top:11px;
    padding:15px; 
  }
  .benchtabactive{
    border-bottom: 2px solid #ababab;
  }
  hr {
    border-top: 1px solid #ababab;
  }
  #pick-part-modal{
    position:fixed;
    top:50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #f2f2f2;
    text-shadow: none;
    color: #010101;
  }
  .equip-part-item{
    border: solid 1px #d9d9d9;
    display: inline-block;
    width: 445px;
    margin: 8px;
    text-align: left;
    cursor: pointer;
  }
  .not-equipped:hover{
    background-color: #eee;
  }
  .equipped{
    background-color:#2F2F2F;
  }
  .part-item-title{
    font-size: 18px;
  }
  .component-tab-cube-image{
    width:30px;
  }
  .part-item-sub{
    color:#9f9f9f;
    display:block;
    font-size: 11px;
  }
  .part-item-border{
    border-left: solid 17px #f3f3f3;
  }
  .part-item-content {
    padding:8px;
    display:inline-block;
    height:75px;
    vertical-align: top;
    padding-left:15px;
  }
  .part-item-icon{
    position: relative;
    width: 32px;
    left: -25px;
    top: 8px;
  }
  .part-item-flag{
    display: inline-block;
    background-color: #3e3e3e;
    color: white;
    padding: 3px;
    width: 128px;
    text-align: center;
    position: relative;
    right: -5px;
    top: 9px;
    font-size: 12px;
    float:right;
  }
  .part-icon-div{
    display:inline-block;
    vertical-align: top;
    width: 0px;
  }
  .bg-orange {
    background-color: #fede86;
  }
  .border-orange{
    border-color: #fede86 !important;
  }
  .border-purple{
    border-color: #fe4aea !important;
  }
  .border-blue{
    border-color: #29a0de !important;
  }
  .border-gray{
    border-color: #333333 !important;
  }
  .border-black{
    border-color: #000000 !important;
  }
  .border-default{
    border-color: #cccccc !important;
  }
  
  .fg-purple{
    color: #fe4aea;
  }
  .fg-orange{
    color: #e6d55e;
  }
  .fg-gray{
    color: #777;
  }
  .fg-gray{
    color: #777;
  }
  .fg-white{
    color: #888;
  }
  .fg-blue{
    color: #29a0de;
  }
  .fg-inc{
    color: #b9b9b9;
  }
  .fg-inc-red{
    color: #f4101a;
    font-weight: bold;
  }
  .blue-button{
    background-color:#1A9DFC;
  }
  .modal-button{
    color:white;
    font-weight: normal;
    font-size: 10px;
    padding-left: 50px;
    padding-right:50px;
    margin:5px;
  }
  #part-item-list{
    padding:10px;
    background-color:#ffffff;
    border-bottom: solid 1px #c1c1c1;
    overflow-y:auto;
    height:300px;
  }
  .equip-clickable{
    cursor: pointer;
  }
  
  #cubedisplay-bg{
    position: absolute;
    left:17px;
  }
  #cubedisplay-middle{
    position: absolute;
    top: 0px;
    left: 17px;
  }
  #cubedisplay-display{
    position: absolute;
    top: -15px;
    left: 385px;
  }
  #cubedisplay-memory{
    position: absolute;
    top: 329px;
    left: 203px;
  }
  #cubedisplay-cpu{
    position: absolute;
    top: 285px;
    left: 320px;
  }
  #cubedisplay-gpu{
    position: absolute;
    top: 108px;
    left: 39px;
  }
  
  .acbench-item-heading{
    font-family: 'Open Sans', sans-serif;
    color:#c2bad1;
    font-weight: 300;
    font-size: 28px;
  }
  
  
  #ac-cube-section-gpu{
    position: absolute;
    top: 179px;
    left: 35px;
  }
  #ac-cube-section-cpu{
    position: absolute;
    top: 20px;
    left: 35px;
  }
  #ac-cube-section-memory{
    position: absolute;
    top: 348px;
    left: 35px;
  }
  #ac-cube-section-display{
    position: absolute;
    top: 523px;
    left: 35px;
  }
  
  #ac-cubedisplay-middle{
    position: absolute;
    top: 144px;
    left: 675px;
  }
  #ac-cubedisplay-gpu{
    position: absolute;
    top: 136px;
    left: 585px;
  }
  #ac-cubedisplay-cpu{
    position: absolute;
    top: 135px;
    left: 882px;
  }
  #ac-cubedisplay-memory{
    position: absolute;
    top: 396px;
    left: 734px;
  }
  #ac-cubedisplay-display{
    position: absolute;
    top: 418px;
    left: 886px;
  }
  
  #bench-cube-title{
    border-left: solid 4px #cccccc;
    display: inline-block;
    padding-left: 15px;
  }
  #bench-cube-subtitle{
    font-size: 14px;
    display: block;
    top: -10px;
    padding-left: 20px;
    position: relative;
  }
  </style>
{% endblock %}

{% block navleft %}
<h3 class="navbar-page-title">
  Finish building your Cube
</h3>
{% endblock %}


{% block content %}
  <div style="width:100%; border-bottom: 3px #2a263f solid; text-align: center;" class="wizard-steps-breadcrumbs">
    <ul>
      <li>CONFIGURE</li>
      <li>NAME</li>
      <li class="active">BUILD & FINISH</li>
    </ul>
  </div>
  <br><br>

  <div class="container">
  
    <div class="row">
      <div class="col-md-8">
        <h1 id="bench-cube-title">Cube Title</h1>
        <span id="bench-cube-subtitle">Performance subtitle</span>
      </div>
      <div class="col-md-4">
        <br>
        <button class="ac-btn">Save Cube</button>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        
        <img src="/static/images/cube-with-lines.png">
        <div id="ac-cube-section-cpu" data-equip-type="cpu" data-equip-title="EQUIP A PROCESSOR">
          <span class="acbench-item-heading" style="display:block;">Processor</span>
          <button class="ac-btn equipbutton" style="display: block; margin-top: 5px;">Equip An Item</button>
          <div id="ac-cpu-section" class="equip-clickable item-slot-section"></div>
        </div>
        
        <div id="ac-cube-section-gpu" data-equip-type="gpu" data-equip-title="EQUIP A GRAPHICS CARD">
          <span class="acbench-item-heading" style="display:block;">Graphics</span>
          <button class="ac-btn equipbutton" style="display: block; margin-top: 5px;">Equip An Item</button>
          <div id="ac-gpu-section" class="equip-clickable item-slot-section"></div>
        </div>
        
        <div id="ac-cube-section-memory" data-equip-type="memory" data-equip-title="EQUIP MEMORY">
          <span class="acbench-item-heading" style="display:block;">Memory</span>
          <button class="ac-btn equipbutton" style="display: block; margin-top: 5px;">Equip An Item</button>
          <div id="ac-memory-section" class="equip-clickable item-slot-section"></div>
        </div>
        
        <div id="ac-cube-section-display" data-equip-type="display" data-equip-title="EQUIP A DISPLAY">
          <span class="acbench-item-heading" style="display:block;">Display</span>
          <button class="ac-btn equipbutton" style="display: block; margin-top: 5px;">Equip An Item</button>
          <div id="ac-display-section" class="equip-clickable item-slot-section"></div>
        </div>
        
        <!-- CUBE DISPLAY -->
        <!-- - - - - - - - -->
        <!-- Default cube images go here! -->
        <img src="/static/cube-images/ac-cube-middle-default.png" id="ac-cubedisplay-middle" />
        <img src="/static/cube-images/ac-cube-small-default.png" id="ac-cubedisplay-gpu" />
        <img src="/static/cube-images/ac-cube-small-default.png" id="ac-cubedisplay-cpu" />
        <img src="/static/cube-images/ac-cube-small-default.png" id="ac-cubedisplay-memory" />
        <img src="/static/cube-images/ac-cube-small-default.png" id="ac-cubedisplay-display" />
        <!--// Cube DISPLAY -->
      </div>
    </div>   
    
  </div>
  
  <div class="container" id="pick-part-modal">
    <div class="row">
      <div class="col-md-12" style="padding:0px;">
        <div style="text-align: center; padding:15px; border-bottom: solid 1px #c1c1c1;">
          <b><span id="equip-modal-title"></span></b>
          <button class="blue-link modal-button pull-right" id="modal-unequip-btn">UNEQUIP »</button>
          <div class="clearfix"></div>
        </div>
        <div style="padding:10px; background-color:#d9d9d9; border-bottom: solid 1px #c1c1c1;">
          <div class="pull-left">
            <input type="text" placeholder="Search for part"/>&nbsp;&nbsp;&nbsp;
            <input type="checkbox"/>&nbsp;&nbsp;&nbsp;<label for="">Show only compatible</label>
          </div>
          <div class="pull-right">
            <span>Sort by:&nbsp;&nbsp;</span>
            <select>
              <option value="volvo">All manufacturers</option>
            </select>
            <select>
              <option value="volvo">Amdahl Rank</option>
            </select>
          </div>
          <div class="clearfix"></div>
        </div>
        
        <!-- ITEM LIST -->
        <div id="part-item-list">
          <div class="equip-part-item">
            <div class="part-item-border border-orange">
              <div class="part-icon-div">
                <img src="/static/images/part-item-orange.png" class="part-item-icon"/>
              </div>
              <div class="part-item-content">
                <span class="part-item-title fg-orange">Samsung 28" UHD Monitor</span>
                <span class="part-item-sub">4K RESOLUTION</span>
                <span class="part-item-sub">10 MS RESPONSE</span>
              </div>
              <div class="part-item-flag">
                RECOMMENDED
              </div>
            </div>
          </div>
          <div class="equip-part-item">
            <div class="part-item-border">
              <div class="part-icon-div">
                <img src="/static/images/part-item-inc.png" class="part-item-icon"/>
              </div>
              <div class="part-item-content">
                <span class="part-item-title fg-inc">Samsung 28" UHD Monitor</span>
                <span class="part-item-sub fg-inc-red">INCOMPATIBLE</span>
              </div>
            </div>
          </div>
          <div class="equip-part-item">
            <div class="part-item-border">
              <div class="part-icon-div">
                <img src="/static/images/part-item-inc.png" class="part-item-icon"/>
              </div>
              <div class="part-item-content">
                <span class="part-item-title fg-inc">Samsung 28" UHD Monitor</span>
                <span class="part-item-sub fg-inc-red">INCOMPATIBLE</span>
              </div>
            </div>
          </div>
        </div>
        <div style="padding:10px; border-bottom: solid 1px #c1c1c1; text-align: center;">
          <button class="blue-link modal-button" id="modal-cancel-btn">CANCEL »</button>
          <button class="blue-link modal-button" id="modal-save-btn">SAVE PART »</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block javascript %}

<script type="text/javascript">
	//
	// initialize globals
	var AC_GLOBALS = function(){
		return {
			cubeName : {% if cube_name %}'{{cube_name}}'{% else %}null{% endif %},
			preset : {% if preset %}'{{preset}}'{% else %}null{% endif %},
			rig : {% if rig %}'{{rig.id}}'{% else %}null{% endif %}
		};
	}();

</script>

<script type="text/javascript">
    //initialize rig (local storage)
    var currentRig = {};
    currentRig['parts'] = currentRig['parts'] || {};
	$(function(){
		
		// set cube name
		currentRig['name'] = (AC_GLOBALS.cubeName !== null) ? AC_GLOBALS.cubeName : 'The Beast';
		
		// prepare preset values
		if (AC_GLOBALS.preset !== null) {
			// get preset config from server
			$.getJSON( "getrig", {rig_id: AC_GLOBALS.preset}).success(function(data) {
				var presetRig = JSON.parse(data.rig);
				console.log(presetRig);
				if (presetRig['motherboard_component_id'] !== undefined) currentRig['parts']['motherboard_id'] = presetRig['motherboard_component_id'];
                if (presetRig['gpu_component_id'] !== undefined) currentRig['parts']['gpu_id'] = presetRig['gpu_component_id'];
                if (presetRig['memory_component_id'] !== undefined) currentRig['parts']['memory_id'] = presetRig['memory_component_id'];
                if (presetRig['display_component_id'] !== undefined) currentRig['parts']['display_id'] = presetRig['display_component_id'];
                if (presetRig['cpu_component_id'] !== undefined) currentRig['parts']['cpu_id'] = presetRig['cpu_component_id'];
                
                refreshPartsCache(renderRig);
			});
		}
		
		// initial render
		refreshPartsCache(renderRig);
		
		//
		//
		// initialization complete
		// set up bindings etc.
		//
		//
		
		$('#save-my-cube-button').click(function(){
			// if the user is logged in this link will click off save
			// else the user will need to register before they can save
			ArcticBasics.isLoggedIn(saveCube, function(){
				// not logged in
				ArcticBasics.initLogin(saveCube);
			});
		});
		
		function saveCube(){
			alert('INIT SAVE!!');
			
			var postRig = currentRig['parts'];
			postRig['name'] = currentRig['name'];
			//postRig.rig_id = //TODO
			
			$.post('/savecube', postRig).success(function(data){
				alert('response ' + data)
			});
			
		}
	
		$('#reset-cube-button').click(resetCube);
		
		function resetCube(){
		    currentRig = {};
		    currentRig['parts'] = {};
		    renderRig();
		}
		
		// selected item prior to save
		var toEquip = null;
		var equipType = null;
		
		// initialize parts cache with part data by id
		var partsCache = {};
		
 		$('#pick-part-modal').hide();
 		
 		//
 		// dismiss modal after saving
 		//
 		$('#modal-save-btn').click(function(){
 			console.log('equip ' + equipType + ' ' + toEquip);
 			currentRig['parts'][equipType + '_id'] = toEquip;
 			$('#pick-part-modal').hide();
 			renderRig();
 		});
 		
 		$('#modal-unequip-btn').click(function(){
 			console.log('unequip ' + equipType);
 			currentRig['parts'][equipType + '_id'] = null;
 			$('#pick-part-modal').hide();
 			renderRig();
 		});
 		
 		//
 		// dismiss modal (cancel)
 		//
 		$('#modal-cancel-btn').click(function(){
 			$('#pick-part-modal').hide();
 		});
		
		//
		// equip buttons - show modal and load parts
		//
		$('.equipbutton').click(renderPartPickerModal);
		$('.equip-clickable').click(renderPartPickerModal);
		
		function renderPartPickerModal() {
			//
			// clear out any previously selected parts
			toEquip = null;
			
			//
			// set title
			var equipTitle = $(this).parent().data('equip-title');
			$('#equip-modal-title').html(equipTitle);
			
			var eType = $(this).parent().data('equip-type');
			equipType = eType;
			
			var currentEquippedId = currentRig['parts'][eType + '_id'];
	        
	        // Call server with datatype and current PC config
	        var getPartsParams = {};
	        getPartsParams.target = eType;
	        $.extend(getPartsParams, currentRig['parts']);
	        $.getJSON( "getparts", getPartsParams).success(function(data) {
	        	
	        	var itemListView = $('#part-item-list');
	        	itemListView.empty();
	        	
				var partsList = JSON.parse(data.parts);
	        	for (part in partsList) {	        		
	        		var component = partsList[part];
	        		
	        		//
	        		// add to parts cache (needed later)
	        		partsCache[component.id] = component;
	        		
        			var itemDiv = $('<div class="equip-part-item"></div>')
        			var borderDiv = $('<div class="part-item-border"></div>');
        			var contentDiv = $('<div class="part-item-content"></div>')
        			var iconDiv = $('<div class="part-icon-div"></div>')
        			var titleSpan = $('<span class="part-item-title">' + constructDisplayName(component) + '</span>');
        			
        			itemDiv.append(borderDiv);
        			borderDiv.append(iconDiv);
        			borderDiv.append(contentDiv);
        			contentDiv.append(titleSpan);
        			
        			//
        			// set component ID
        			//
        			itemDiv.data('component-id', component.id);
        			
        			// style current equipped if exists
        			if (currentEquippedId === component.id) {
        				itemDiv.addClass('equipped');
        			} else {
        				itemDiv.addClass("not-equipped");
        			}
        			
        			if (component.compatible === true) {
        				borderDiv.addClass('border-' + component.perf_color); 										// border color
        				iconDiv.append('<img src="/static/images/part-item-'+component.perf_color+'.png" class="part-item-icon"/>') 	// color icon
        				titleSpan.addClass('fg-' + component.perf_color);											// style title span
        				contentDiv.append('<span class="part-item-sub">' + constructPerformanceNote(component) + '</span>');
        				
        				// add any flags
            			// adding recommended to all for now
            			if (component.recommended === true ) {
            				borderDiv.append('<div class="part-item-flag">RECOMMENDED</div>');
            			}
        				
        			} else {        				
        				iconDiv.append('<img src="/static/images/part-item-inc.png" class="part-item-icon"/>') 	// append incompat icon
        				contentDiv.append('<span class="part-item-sub fg-inc-red">INCOMPATIBLE</span>'); 			// incompatible text
        				titleSpan.addClass('fg-inc'); 															// title color
        			}
        			
        			itemListView.append(itemDiv);
        			
	        	}
	        	
	        	bindEquipListener();

	        }).fail(function() {
	            console.log( "error" );
	        });
			
			$('#pick-part-modal').show();
		}
		
		//
		// Equip Part Item onClick
		// Change styling
		//
		function bindEquipListener(){
			$('.equip-part-item').click(function(){
				// remove equip styling from all components
				$('.equip-part-item').removeClass('equipped');
				$(this).addClass('equipped');
				$(this).removeClass('not-equipped');
				toEquip = $(this).data('component-id');
				console.log('the data: ' + toEquip);
			});
		}
		
		//
		// Render Bench View
		//
		function renderRig() {
			console.log('Rendering Rig');
			console.log(currentRig);
			
			//
			//
			// RESET Cube positions
			$('#ac-cubedisplay-middle').attr('src','/static/cube-images/ac-cube-middle-default.png');
			$('#ac-cubedisplay-gpu').attr('src','/static/cube-images/ac-cube-small-default.png');
			$('#ac-cubedisplay-cpu').attr('src','/static/cube-images/ac-cube-small-default.png');
			$('#ac-cubedisplay-memory').attr('src','/static/cube-images/ac-cube-small-default.png');
			$('#ac-cubedisplay-display').attr('src','/static/cube-images/ac-cube-small-default.png');
			$('#cube-avatar').attr('src', '/static/cube-images/cube-avatar-default.png');
			
			//
			//
			// show all equip buttons
			$('.equipbutton').show();
			
			//
			//
			// Remove display titles
			$('.item-slot-section').empty();
			
			//
			//
			// Disable save and share button (assume cube positions have not all been filled)
			$('#save-my-cube-button').prop('disabled', true);
			$('#benchtab-share').addClass('benchtab-disabled');
			
			var coreComponentCount = 0;
			var worstComponent = null;
			var worstComponentDetail = null;
			
			// render the current rig
			for (comp in currentRig['parts']) {
				
				var compId = currentRig['parts'][comp];
				if (compId === null || compId === undefined) {
					continue;
				}
				
				// pull part and information from cache
				var partDetail = partsCache[compId];
				
				// comptype
				var compType = comp.substr(0, comp.indexOf('_id'));
				console.log('comp type: ' + compType);
				
				// modify view
				var view = $('#ac-' + compType + '-section');
				view.prev().hide();
				view.empty();
				
				var displaySpan = $('<span></span>');
				displaySpan.append(constructDisplayName(partDetail));
				displaySpan.addClass('fg-' + partDetail.perf_color);
				displaySpan.addClass('part-item-title');

				view.append(displaySpan.clone());
				view.append('<br><span>' + constructPerformanceNote(partDetail) + '</span>')
				
				// modify colors
				$('#ac-cubedisplay-' + compType).attr('src',
						'/static/cube-images/ac-cube-small-' + partDetail.perf_color + '.png');
				
				//
				// incremenent component count
				// and set worst component
				if (isCoreComponent(compType)) {
					coreComponentCount++;
					if (worstComponent == null || partDetail.perf_color_coded < worstComponent) {
  						worstComponent = partDetail.perf_color_coded;
  						worstComponentDetail = partDetail;
					}
				}
			}
			
			if (coreComponentCount == 4) {
				// set center cube and avatar cubes
				$('#ac-cubedisplay-middle').attr('src','/static/cube-images/ac-cube-middle-' + worstComponentDetail.perf_color + '.png');
				//$('#cube-avatar').attr('src', '/static/cube-images/cube-avatar-' + worstComponentDetail.perf_color + '.png');
				$('#bench-cube-title').addClass('border-' + worstComponentDetail.perf_color);
				
				// enable save button and share button
				$('#save-my-cube-button').prop('disabled', false);
				$('#benchtab-share').removeClass('benchtab-disabled');
			}
			
			// set rig name
			if (currentRig.name !== undefined) {
				$('#rig_name_main').html(currentRig['name']);
			}		
			
		}
		
		function constructDisplayName(part){
			var partName = "";
			if (part.vendor !== undefined && part.vendor !== null) partName += part.vendor + ' ';
			if (part.brand_name !== undefined && part.brand_name !== null) partName += part.brand_name + ' ';
			if (part.model_number !== undefined && part.model_number !== null) partName += part.model_number;
			return partName;
		}
		
		function constructPerformanceNote(part){
			var note = "";
			if (part.max_performance !== undefined && part.max_performance !== null) note += part.max_performance + ' ';
			if (part.resolution !== undefined && part.resolution !== null) note += part.resolution;
			if (part.max_framerate !== undefined && part.max_framerate !== null) note += '<br>' + part.max_framerate + ' MS Response Time';
			return note;
		}
		
		function isCoreComponent(compType) {
			return compType === 'memory' || compType === 'display' || compType === 'cpu' || compType === 'gpu';
		}
		
		function refreshPartsCache(renderFunc){
			// retrieve necessary parts from server
			var ids = '';
			var count = 0;
			for (part in currentRig['parts']) {
				count++;
				if (currentRig['parts'][part] === null) continue;
				
				ids += currentRig['parts'][part];
				if (count < Object.keys(currentRig.parts).length) {
					ids += ',';
				}
			}
			if (ids.length === 0) return;
			$.getJSON( "getparts", {ids:ids}).success(function(data) {
				var partsList = JSON.parse(data.parts);
	        	for (part in partsList) {
	        		var component = partsList[part];
	        		partsCache[component.id] = component;
	        	}
	        	
	        	if (renderFunc !== null) {
	        		renderFunc();
	        	}
			});
		}
		
		
		
	});

	
	
</script>
{% endblock %}


